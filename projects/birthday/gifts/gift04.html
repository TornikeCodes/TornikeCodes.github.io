<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gift 4 - Photo Reveal</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  font-family:'Poppins', sans-serif;
}

body {
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  position:relative;
}

@keyframes gradientBG {
  0% {background-position:0% 50%;}
  50% {background-position:100% 50%;}
  100% {background-position:0% 50%;}
}

/* Full-viewport animated background behind all content to avoid seams/restarts */
body::before {
  content: "";
  position:fixed;
  inset:0;
  z-index:-1;
  background: linear-gradient(270deg, #ffdde1, #ee9ca7, #ffe7e7, #ffc3a0);
  background-size: 800% 800%;
  animation: gradientBG 30s ease infinite;
  will-change: background-position;
}

.container {
  position:relative;
  width:400px;
  max-width:90vw;
  height:600px;
  max-height:90vh;
  border-radius:20px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
  background:#f9f0f0;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.caption-container {
  width:100%;
  padding:15px;
  background: rgba(255,255,255,0.85);
  text-align:center;
  font-weight:600;
  color:#4b2330;
  font-size:1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index:3;
}

.scratch-container {
  position:relative;
  flex:1;
  width:100%;
}

#hiddenImage {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:0 0 20px 20px;
  z-index:1;
}

#scratchCanvas {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  z-index:2;
  cursor:crosshair;
}

.heart {
  position:fixed;
  left:0;
  top:0;
  font-size:16px;
  transform:translate(-50%,-50%);
  animation:floatUp 1s ease forwards;
  pointer-events:none;
  z-index:9999;
}

@keyframes floatUp {
  0% {transform:translate(-50%,-50%) scale(1) translateY(0); opacity:1;}
  100% {transform:translate(-50%,-50%) scale(1.5) translateY(-50px); opacity:0;}
}

.back-btn {
  margin:5px;
  padding:8px 18px;
  background:#4b2330;
  color:white;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  z-index:5;
}

#downloadBtn {
  margin:5px;
  padding:8px 18px;
  background:#ff6384;
  color:white;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  display:none;
  z-index:5;
}
</style>
</head>
<body>
<div class="container">
  <div class="caption-container">
    As your fourth gift, scratch to reveal a special memory ðŸ’–<br>
    (You can download it after revealing 90%)
  </div>
  <div class="scratch-container">
    <img id="hiddenImage" src="image.jpg" alt="Special photo"> <!-- replace with your photo -->
    <canvas id="scratchCanvas"></canvas>
  </div>
  <button id="downloadBtn">Download Image ðŸ’–</button>
  <button class="back-btn" onclick="window.location.href='../index.html'">Back to gifts</button>
</div>

<script>
const canvas = document.getElementById('scratchCanvas');
const ctx = canvas.getContext('2d');
const scratchContainer = document.querySelector('.scratch-container');
const downloadBtn = document.getElementById('downloadBtn');
const hiddenImage = document.getElementById('hiddenImage');

function resizeCanvas(){
  const dpr = window.devicePixelRatio || 1;
  const width = scratchContainer.clientWidth;
  const height = scratchContainer.clientHeight;
  canvas.width = Math.max(1, Math.floor(width * dpr));
  canvas.height = Math.max(1, Math.floor(height * dpr));
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  // reset transform and scale for crisp drawing on high-DPI
  ctx.setTransform(dpr,0,0,dpr,0,0);
  // fill scratch layer
  ctx.fillStyle = '#b0b0b0';
  ctx.globalCompositeOperation = 'source-over';
  ctx.fillRect(0,0,width,height);
}

// initial size and on resize
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

let isDrawing = false;
let downloadShown = false;

function getMousePos(e){
  const rect = canvas.getBoundingClientRect();
  return {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top
  };
}

canvas.addEventListener('mousedown', e=>{isDrawing=true; scratch(e);});
canvas.addEventListener('mousemove', e=>{if(isDrawing)scratch(e);});
canvas.addEventListener('mouseup', e=>{isDrawing=false; checkReveal();});
canvas.addEventListener('mouseleave', e=>{isDrawing=false; checkReveal();});

canvas.addEventListener('touchstart', e=>{isDrawing=true; scratch(e.touches[0]);});
canvas.addEventListener('touchmove', e=>{if(isDrawing)scratch(e.touches[0]);});
canvas.addEventListener('touchend', e=>{isDrawing=false; checkReveal();});

function scratch(e){
  const pos = getMousePos(e);
  const radius = 25;
  ctx.globalCompositeOperation = 'destination-out';
  ctx.beginPath();
  ctx.arc(pos.x,pos.y,radius,0,Math.PI*2);
  ctx.fill();
  // spawn heart at page coordinates so it lines up with the cursor
  const rect = canvas.getBoundingClientRect();
  spawnHeart(rect.left + pos.x, rect.top + pos.y);
}

function spawnHeart(x,y){
  const heart = document.createElement('div');
  heart.classList.add('heart');
  // add a tiny random offset so multiple hearts don't perfectly overlap
  const ox = (Math.random()-0.5) * 20;
  const oy = (Math.random()-0.5) * 20;
  heart.style.left = (x + ox) + 'px';
  heart.style.top = (y + oy) + 'px';
  // randomize size slightly
  const scale = 0.9 + Math.random() * 0.4;
  heart.style.fontSize = (16 * scale) + 'px';
  heart.innerText='ðŸ’–';
  document.body.appendChild(heart);
  setTimeout(()=>heart.remove(),1000);
}

function checkReveal(){
  if(downloadShown) return;
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const pixels = imageData.data;
  let transparentCount = 0;
  for(let i=3;i<pixels.length;i+=4){
    if(pixels[i] === 0) transparentCount++;
  }
  const percent = transparentCount / (canvas.width*canvas.height);
  if(percent >= 0.9){
    downloadShown = true;
    downloadBtn.style.display = 'block';
    downloadBtn.onclick = ()=>{
      const link = document.createElement('a');
      link.href = hiddenImage.src;
      link.download = 'special-photo.jpg';
      link.click();
    };
  }
}
</script>
</body>
</html>
