<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gift 4 - Puzzle</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  margin:0;
  height:100vh;
  font-family:'Poppins', sans-serif;
  background: linear-gradient(270deg, #ffdde1, #ee9ca7, #ffe7e7, #ffc3a0);
  background-size: 800% 800%;
  animation: gradientBG 30s ease infinite;
  overflow:hidden;
  display:flex;
  justify-content:center;
  align-items:center;
  color:#4b2330;
}

@keyframes gradientBG {
  0% {background-position:0% 50%;}
  50% {background-position:100% 50%;}
  100% {background-position:0% 50%;}
}

.container {
  position:relative;
  display:flex;
  justify-content:center;
  align-items:center;
}

.puzzle-box {
  position:relative;
  background:#f9f0f0;
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(2, 1fr);
  gap:0px;
  border-radius:10px;
  z-index:1;
}

.tile {
  position:absolute;
  cursor:grab;
  border-radius:5px;
  box-shadow:0 5px 15px rgba(0,0,0,0.2);
  transition: transform 0.3s ease, left 0.3s ease, top 0.3s ease;
}

.tile.dragging {
  z-index:10;
  opacity:0.9;
}

.status {
  position:absolute;
  bottom:10px;
  font-size:1.1rem;
  width:100%;
  text-align:center;
  font-weight:600;
}

.back-btn {
  position:absolute;
  bottom:40px;
  padding:10px 20px;
  background:#4b2330;
  color:white;
  border:none;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}

/* Heart particle effect */
.heart {
  position:absolute;
  font-size:16px;
  animation:floatUp 1s ease forwards;
  pointer-events:none;
  z-index:20;
}

@keyframes floatUp {
  0% {transform:scale(1) translateY(0); opacity:1;}
  100% {transform:scale(1.5) translateY(-50px); opacity:0;}
}

/* Confetti */
.confetti-piece {
  position:absolute;
  width:8px; height:8px;
  opacity:0.8;
  z-index:30;
  animation:fall 2s linear forwards;
}

@keyframes fall {
  0% {transform:translateY(0) rotate(0deg);}
  100% {transform:translateY(300px) rotate(720deg); opacity:0;}
}
</style>
</head>
<body>
<div class="container" id="container">
  <div class="puzzle-box" id="puzzleBox"></div>
  <div class="status" id="status">Arrange all tiles to complete the puzzle</div>
  <button class="back-btn" onclick="window.location.href='../index.html'">Back to gifts</button>
</div>

<script>
const imageSrc = 'image.jpg'; // replace with your image
const puzzleBox = document.getElementById('puzzleBox');
const container = document.getElementById('container');
const status = document.getElementById('status');

const ROWS = 2;
const COLS = 4;
const TILE_COUNT = ROWS*COLS;
let tiles = [];

const img = new Image();
img.src = imageSrc;
img.onload = () => {
  const imgWidth = img.width;
  const imgHeight = img.height;

  // set puzzle box size to match image
  puzzleBox.style.width = imgWidth+'px';
  puzzleBox.style.height = imgHeight+'px';
  puzzleBox.style.gridTemplateColumns = `repeat(${COLS}, ${imgWidth/COLS}px)`;
  puzzleBox.style.gridTemplateRows = `repeat(${ROWS}, ${imgHeight/ROWS}px)`;

  const tileWidth = imgWidth / COLS;
  const tileHeight = imgHeight / ROWS;

  // create tiles
  for(let i=0;i<TILE_COUNT;i++){
    const tile = document.createElement('div');
    tile.classList.add('tile');
    tile.style.width = tileWidth+'px';
    tile.style.height = tileHeight+'px';
    tile.style.backgroundImage = `url(${imageSrc})`;
    
    const row = Math.floor(i / COLS);
    const col = i % COLS;
    tile.dataset.correctX = col*tileWidth;
    tile.dataset.correctY = row*tileHeight;
    tile.style.backgroundSize = `${imgWidth}px ${imgHeight}px`;
    tile.style.backgroundPosition = `-${col*tileWidth}px -${row*tileHeight}px`;

    // random position on the screen
    tile.style.left = Math.random()*(window.innerWidth - tileWidth) + 'px';
    tile.style.top = Math.random()*(window.innerHeight - tileHeight) + 'px';

    container.appendChild(tile);
    tiles.push(tile);
    makeDraggable(tile, tileWidth, tileHeight, imgWidth, imgHeight);
  }
};

function makeDraggable(tile, tileW, tileH, imgW, imgH){
  let offsetX, offsetY, isDragging=false;

  tile.addEventListener('mousedown', e=>{
    isDragging=true;
    tile.classList.add('dragging');
    offsetX = e.clientX - tile.offsetLeft;
    offsetY = e.clientY - tile.offsetTop;
  });

  window.addEventListener('mousemove', e=>{
    if(!isDragging) return;
    tile.style.left = (e.clientX - offsetX) + 'px';
    tile.style.top = (e.clientY - offsetY) + 'px';
  });

  window.addEventListener('mouseup', e=>{
    if(!isDragging) return;
    isDragging=false;
    tile.classList.remove('dragging');

    const rect = puzzleBox.getBoundingClientRect();
    const mouseX = e.clientX;
    const mouseY = e.clientY;

    if(mouseX > rect.left && mouseX < rect.right && mouseY > rect.top && mouseY < rect.bottom){
      const snapX = Math.floor((mouseX - rect.left) / tileW) * tileW;
      const snapY = Math.floor((mouseY - rect.top) / tileH) * tileH;

      tile.style.left = rect.left + snapX + 'px';
      tile.style.top = rect.top + snapY + 'px';

      spawnHeart(mouseX, mouseY);
    }

    checkCompletion();
  });
}

function spawnHeart(x,y){
  const heart = document.createElement('div');
  heart.classList.add('heart');
  heart.style.left = x+'px';
  heart.style.top = y+'px';
  heart.innerText='ðŸ’–';
  document.body.appendChild(heart);
  setTimeout(()=>heart.remove(),1000);
}

function spawnConfetti(){
  for(let i=0;i<40;i++){
    const c = document.createElement('div');
    c.classList.add('confetti-piece');
    c.style.left = Math.random()*window.innerWidth + 'px';
    c.style.background = `hsl(${Math.random()*360},70%,70%)`;
    container.appendChild(c);
    setTimeout(()=>c.remove(),2000);
  }
}

function checkCompletion(){
  let correct = true;
  const rect = puzzleBox.getBoundingClientRect();
  tiles.forEach(tile=>{
    const x = parseInt(tile.style.left) - rect.left;
    const y = parseInt(tile.style.top) - rect.top;
    if(Math.abs(x - tile.dataset.correctX) > 5 || Math.abs(y - tile.dataset.correctY) >5){
      correct=false;
    }
  });

  if(correct){
    status.innerHTML = 'ðŸŽ‰ Puzzle completed! <a id="downloadLink" href="'+imageSrc+'" download>Click here to download ðŸ’–</a>';
    spawnConfetti();
  } else {
    status.innerText = 'Arrange all tiles to complete the puzzle';
  }
}
</script>
</body>
</html>
